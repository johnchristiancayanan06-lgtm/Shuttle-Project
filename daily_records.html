<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EASTWEST Shuttle - Records</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="icon" href="styles/logo.webp" type="image/webp">
</head>

<body class="dashboard">

<!-- SIDEBAR -->
<aside class="sidebar">
    <div class="logo">EW Shuttle System</div>

    <ul class="menu">
        <li><a href="dashboard.html"><strong>Dashboard</strong></a></li>
        <li id="accountsMenuItem"><a href="Account.html">Accounts</a></li>

        <li>
            <div class="dropdown-btn" onclick="toggleDropdown('shuttleMenu')">
                Shuttle ▾
            </div>
            <ul class="dropdown-menu" id="shuttleMenu">
                <li><a href="shuttle.html?id=1">Shuttle 1</a></li>
                <li><a href="shuttle.html?id=2">Shuttle 2</a></li>
                <li><a href="shuttle.html?id=3">Shuttle 3</a></li>
            </ul>
        </li>

        <li class="active"><a href="daily_records.html">Records</a></li>
    </ul>
        <!-- Dashboard-only sidebar footer logo -->
        <div class="dashboard-sidebar-footer">
            <img src="styles/sidebarlogo.jpg" alt="EastWest BPO Logo">
        </div>
    </aside>

<!-- MAIN -->
<div class="main">

    <!-- TOPBAR -->
    <header class="topbar">
        <div class="user-dropdown">
            <button class="user-btn" onclick="toggleUserMenu()">
                <span id="currentUserDisplay">Loading...</span> ▾
            </button>
            <ul class="user-menu" id="userMenu">
                <li><a href="#" onclick="handleLogout(event)">Logout</a></li>
            </ul>
        </div>
    </header>

    <!-- CONTENT -->
    <main class="content">

        <!-- FILTER + EXPORT -->
        <div class="top-controls">
            <div class="filter-bar">
                <div class="filter-group">
                    <label>From</label>
                    <input type="date" id="fromDate">
                </div>

                <div class="filter-group">
                    <label>To</label>
                    <input type="date" id="toDate">
                </div>

                <button class="filter-btn" onclick="filterRecords()">Filter</button>
                <button class="secondary-btn clear-btn" onclick="clearFilter()">Clear</button>
            </div>

            <button class="primary-btn export-btn" id="exportBtn" onclick="exportExcel()">Export</button>
        </div>

        <!-- TABLE -->
        <section class="chart-box3">
            <h4>All Records — All Shuttles</h4>

            <table id="dailyRecordsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Shuttle No.</th>
                        <th>Employee ID</th>
                    </tr>
                </thead>

                <tbody id="recordsBody">
                    <tr>
                        <td colspan="4" style="text-align:center; color:#999;">
                            No records found
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

    </main>
</div>

<script src="auth.js"></script>
<script>
// ═══════════════════════════════════════════════════════════════
//  PAGE INITIALIZATION
// ═══════════════════════════════════════════════════════════════

let currentSession = requireAuth();
if (!currentSession) {
    // requireAuth will redirect if not authenticated
}

if (!hasPermission(currentSession.role, 'canViewRecords')) {
    alert('You do not have permission to view this page');
    window.location.href = 'dashboard.html';
}

document.getElementById('currentUserDisplay').textContent =
    `${currentSession.username} (${currentSession.role})`;

if (!hasPermission(currentSession.role, 'canViewAccounts')) {
    document.getElementById('accountsMenuItem').style.display = 'none';
}

if (!hasPermission(currentSession.role, 'canExportRecords')) {
    document.getElementById('exportBtn').style.display = 'none';
}

// ═══════════════════════════════════════════════════════════════
//  UI FUNCTIONS
// ═══════════════════════════════════════════════════════════════

function toggleDropdown(id) {
    const menu = document.getElementById(id);
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function toggleUserMenu() {
    const menu = document.getElementById("userMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function handleLogout(event) {
    event.preventDefault();
    if (confirm('Are you sure you want to logout?')) {
        logout();
    }
}

window.addEventListener("click", e => {
    const btn = document.querySelector(".user-btn");
    const menu = document.getElementById("userMenu");
    if (btn && !btn.contains(e.target) && !menu.contains(e.target)) {
        menu.style.display = "none";
    }
});

// ═══════════════════════════════════════════════════════════════
//  RECORDS MANAGEMENT
// ═══════════════════════════════════════════════════════════════

let allRecords = [];

function loadRecords() {
    allRecords = loadData('ew_daily_records', []);
    renderRecords(allRecords);
}

function renderRecords(records) {
    const tbody = document.getElementById("recordsBody");
    tbody.innerHTML = "";

    if (records.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align:center; color:#999;">
                    No records found
                </td>
            </tr>
        `;
        return;
    }

    records.sort((a, b) =>
        new Date(b.departureTime) - new Date(a.departureTime)
    );

    records.forEach(record => {
        const row = document.createElement('tr');

        const departureDate = new Date(record.departureTime);
        const dateStr = departureDate.toLocaleDateString();
        const timeStr = departureDate.toLocaleTimeString();

        row.innerHTML = `
            <td>${dateStr}</td>
            <td>${timeStr}</td>
            <td>Shuttle ${record.shuttleNo}</td>
            <td>${record.employeeId || record.tripNumber}</td>
        `;

        tbody.appendChild(row);
    });
}

function filterRecords() {
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;

    if (!fromDate && !toDate) {
        renderRecords(allRecords);
        return;
    }

    const filtered = allRecords.filter(record => {
        const recordDate = record.date;
        if (fromDate && recordDate < fromDate) return false;
        if (toDate && recordDate > toDate) return false;
        return true;
    });

    renderRecords(filtered);
}

function clearFilter() {
    document.getElementById("fromDate").value = "";
    document.getElementById("toDate").value = "";
    renderRecords(allRecords);
}

function exportExcel() {
    if (!hasPermission(currentSession.role, 'canExportRecords')) {
        alert('You do not have permission to export records');
        return;
    }

    const wb = XLSX.utils.table_to_book(
        document.getElementById("dailyRecordsTable"),
        { sheet: "Daily Records" }
    );

    const today = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `daily_records_${today}.xlsx`);
}

// ═══════════════════════════════════════════════════════════════
//  INITIALIZE PAGE
// ═══════════════════════════════════════════════════════════════

loadRecords();

const today = new Date();
const thirtyDaysAgo = new Date();
thirtyDaysAgo.setDate(today.getDate() - 30);

document.getElementById("toDate").valueAsDate = today;
document.getElementById("fromDate").valueAsDate = thirtyDaysAgo;
</script>

</body>
</html>
